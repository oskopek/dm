import numpy as np
import sys
import random

PRIMES = [28411699,
24640513,
23131967,
16667527,
26873303,
25999513,
30589301,
15661357,
21995339,
28678471,
28197187,
23074091,
26601461,
24190961,
26974943,
23418799,
17370319,
17430307,
19062359,
18801611,
30305447,
31982939,
24351479,
17986453,
25937267,
27200111,
16255831,
25651183,
29825233,
29204969,
25047229,
25333331,
24715781,
28379713,
21977299,
15627413,
24499031,
20821789,
25813121,
19377167,
17556293,
16802507,
23904449,
28134787,
30696371,
19226579,
28574701,
30041383,
28633793,
22610347,
17122291,
23709529,
18956257,
28744759,
30259013,
20553443,
21777953,
17468359,
31266713,
27214771,
16681277,
24978241,
16590421,
20274487,
27457957,
27466073,
23500823,
20274677,
20458033,
29389793,
19943717,
25245313,
30930439,
18869243,
22302613,
18437357,
17758337,
24088459,
16586821,
21080987,
18283913,
21352483,
26889013,
31221961,
18106969,
24734273,
29507033,
18668959,
20435423,
27624577,
23902633,
23765179,
15985979,
17773711,
31199249,
31047431,
31055021,
19990457,
23743591,
16336469,
27673159,
17735057,
19808429,
29757479,
23240831,
30896911,
17662867,
21101903,
19429957,
21109441,
31526503,
21020971,
21083779,
24111881,
20652629,
17454391,
29011373,
23425399,
15585533,
30929849,
21270877,
22736869,
32142653,
28377211,
25331741,
21636163,
23398357,
16615679,
23503349,
20337571,
22234567,
28508807,
16810889,
27067487,
16419751,
26286011,
31816783,
18683647,
23765059,
19196399,
31280959,
31039843,
30781733,
18182369,
24109387,
25992251,
21880403,
18145147,
32434343,
27623507,
24544451,
31899407,
17898079,
18262313,
27207199,
31401707,
21360439,
29519923,
21399649,
16541201,
21637309,
16262989,
18866579,
23750443,
26304673,
19024517,
21579983,
29794969,
22076611,
26238269,
22813073,
24238087,
17637901,
25336697,
26732179,
19600817,
17646691,
27684331,
20973311,
30221969,
26848243,
26276821,
32027767,
23815523,
31528171,
25244783,
20519167,
32329387,
30496201,
18046279,
24764921,
23049931,
27158591,
19651789,
26279437,
23686609,
26355319,
17916049,
31307191,
31235983,
19244759,
16574641,
31109747,
16153391,
26347961,
17466991,
19821383,
17951959,
29525851,
23449369,
32397061,
18990721,
31031879,
25941737,
22462753,
16726609,
27668141,
30372997,
22315207,
24159341,
28125103,
31602689,
30313277,
16470079,
16102201,
27902129,
22142737,
25337353,
30205639,
30119003,
25420643,
27114049,
31066249,
21403849,
21097457,
15496967,
30623207,
26168119,
22670099,
30249889,
27202739,
16400567,
31374731,
26917603,
19155121,
18255799,
28045817,
23285209,
27583789,
27738817,
15490883,
19626493,
29225921,
25342357,
30780413,
32401433,
20769487,
30224977,
30131603,
23941681,
17900893,
31584907,
32201707,
19939307,
21972661,
27761077,
21020941,
31305493,
28953137,
31618519,
30193741,
26534527,
23163031,
31134443,
17052817,
31587767,
22121863,
26390687,
19283087,
25443023,
20087701,
15584221,
31098031,
30585001,
23423311,
17938423,
18689257,
30662351,
23745937,
24249847,
15496099,
26552303,
28642577,
15511393,
15690007,
21358111,
17528387,
21090677,
18966601,
29080867,
27826387,
17852089,
32278481,
25804829,
20694511,
31475141,
30052511,
24120743,
22783613,
23135867,
16857059,
23142169,
17701219,
21489313,
21978017,
20150633,
20657423,
16460261,
23547787,
26073409,
27505679,
26163257,
22926173,
25898659,
21416051,
22356601,
19087547,
26015629,
25270621,
25906451,
19223173,
28519927,
27049777,
18430453,
21584279,
23341771,
20875271,
22393243,
16522423,
18525179,
25209791,
29332489,
25930903,
27540497,
22027877,
15757537,
27158093,
25914299,
16501547,
15794501,
22223533,
30603031,
20295923,
19714199,
19962269,
21106721,
21273611,
23196937,
18908821,
32396447,
18145249,
21490879,
18984013,
27243439,
27380323,
17452691,
17283481,
28362853,
30861359,
19540331,
29078281,
22595369,
27918337,
19029151,
19628857,
16006553,
18583951,
30553547,
17957887,
27911753,
16775267,
27942823,
18928421,
23537681,
26518157,
31193381,
19089809,
23833951,
19862197,
23586221,
16556489,
15747013,
29926777,
27574699,
15642037,
22863563,
32394443,
27949357,
31970339,
27388681,
19051213,
19190789,
23737531,
30851071,
28128853,
24139261,
27364307,
32338751,
26953387,
31481623,
31284907,
21082331,
26413507,
27605447,
19380367,
22193231,
16824923,
23776729,
28873849,
29708993,
16310297,
20841211,
21956813,
31924231,
32411501,
26015317,
31498111,
26913973,
19624651,
27167869,
26470567,
32388101,
30552113,
21402137,
29626897,
15793097,
19805837,
20400841,
26755577,
29292787,
31586717,
18644779,
20616301,
25908907,
31214213,
19014547,
22113043,
30047893,
24325969,
31056407,
26154649,
30759929,
31621123,
30944707,
23715931,
16721041,
25428001,
25701391,
22828171,
23087357,
22774303,
26415049,
20516233,
25219351,
25607689,
28154549,
18929923,
17395823,
16680889,
18357931,
18330391,
30415837,
21909131,
21622501,
29738041,
29583833,
25564433,
20857559,
21336739,
16422019,
27067793,
19601423,
26681071,
18330397,
17967529,
31788347,
18495361,
23932483,
17905793,
23016977,
23859697,
32295587,
23626751,
22099997,
19237943,
15892699,
27577301,
26700361,
28236491,
16526297,
27509407,
17916013,
31885121,
17503517,
19763903,
16175189,
27299917,
22278731,
20829269,
24853523,
22640539,
18925763,
18290639,
15834719,
29326813,
24931961,
24176561,
29656103,
22724843,
21501281,
30100649,
21282007,
26490547,
24023113,
29243677,
21420761,
29406653,
16569347,
18144437,
29491703,
30434317,
30766009,
23261171,
26308657,
17481733,
32274139,
24491213,
25511573,
26860817,
27159641,
31104259,
32114911,
19117013,
32072179,
21053609,
26936659,
22018357,
28575931,
17586949,
24244403,
26602129,
23691691,
21997379,
24941909,
25859903,
31162199,
27919813,
22549013,
19241407,
18924557,
24296479,
24802363,
25289023,
16103959,
29632987,
18172859,
21514903,
20123017,
24786121,
24324277,
18611981,
16879507,
29981669,
21035393,
28620547,
32110961,
31080689,
17030579,
27630319,
22737017,
31466951,
29871427,
27842069,
15613391,
21949531,
26916119,
19347403,
18382753,
20897231,
18849353,
27377491,
22748741,
24603949,
31863343,
24749597,
26331733,
28962581,
24057139,
20954867,
20260663,
18787039,
20210963,
25619369,
18173581,
24748817,
18968749,
21031183,
30637583,
16953817,
19521973,
30336017,
17758757,
26288693,
27684253,
16639451,
19863271,
31143667,
23601659,
30597289,
29655761,
20554363,
29670073,
28205819,
30167729,
25479367,
31947401,
19134547,
23881159,
23025539,
29429539,
27113137,
31747123,
28563763,
28965509,
32439629,
28445327,
30550451,
16008211,
23451121,
24043147,
29776961,
32363423,
18089287,
30912883,
27098483,
27884237,
25084069,
21266911,
25272341,
16278761,
18588673,
19264253,
32216027,
29410349,
21998863,
15934327,
20226289,
19825313,
23452409,
20640313,
17416303,
20241731,
30338969,
17046961,
27841921,
30477523,
31216397,
17552893,
24255883,
25711349,
18464119,
26902639,
23492083,
21329801,
19502513,
31263571,
15789637,
29416139,
21190759,
31599563,
26882249,
25759919,
19221001,
22678741,
21378157,
26907119,
28539743,
28150831,
15514799,
19315963,
22304167,
22222817,
25536751,
25240807,
17663231,
25945783,
26362099,
17434783,
24021013,
25430233,
23362463,
23516681,
17245897,
32128219,
31392619,
15785239,
18059621,
29193757,
27717161,
23047039,
24939413,
31431403,
31837633,
24361171,
20176217,
28853093,
19863737,
27382991,
25421483,
19574791,
23677783,
29704361,
17328013,
30015647,
17482271,
31147013,
18026257,
23178781,
19670549,
28961879,
24145057,
18933637,
26766437,
19157651,
22754509,
27215549,
25222723,
18575503,
22778309,
19304039,
24874537,
29298677,
21781129,
25187131,
28784123,
16846457,
32435477,
30581567,
21077057,
15497543,
26424257,
20589479,
31770301,
32049973,
16878769,
25314871,
26203963,
32427013,
29275331,
21931711,
17688269,
18183173,
32091793,
20194183,
15555479,
26433851,
26664499,
18930407,
23162791,
20153743,
32180419,
31749989,
17571703,
16920569,
19838551,
27861829,
18052813,
16478087,
29127337,
23462143,
23070023,
19417631,
25242911,
19381079,
32263487,
27192989,
19111021,
31121689,
21174899,
21803003,
25474159,
29206381,
16598833,
16129783,
22220453,
28994243,
17206531,
22565287,
31846891,
16822133,
23621671,
17795633,
26951543,
17320727,
26649043,
21459527,
29395999,
22890499,
20511973,
22157089,
18691199,
29647901,
25715881,
31840079,
25775053,
28634857,
19624373,
23781799,
22459043,
17146879,
15650477,
26324773,
17719157,
23912459,
15824443,
26896663,
27544729,
27527939,
23117099,
22820033,
20950687,
22920409,
20910941,
23992121,
22711771,
17865007,
28204409,
30616009,
23098919,
27412657,
27616243,
17812771,
27199283,
20057591,
26254099,
15855773,
26643923,
19366541,
16694929,
17175629,
23612503,
15589439,
16400711,
26357033,
18762607,
23269979,
24462311,
30933569,
16700261,
16805339,
27925889,
15910649,
28170059,
19930291,
29021833,
32205997,
18350231,
30286559,
17525671,
29317273,
23799959,
15804023,
20024527,
25383187,
19369787,
17056747,
19269541,
17920999,
23023739,
22074427,
20503367,
32387053,
18413657,
17672407,
27388951,
21626281,
23260507,
29174659,
21272189,
28834459,
28004953,
28420619,
25474451,
22831397,
30082291,
16583473,
30417557,
22110709,
19654367,
20230489,
26872387,
27888361,
22558927,
21654599,
30420109,
17552531,
27031211,
31355587,
18985397,
27824653,
28935253,
19107233,
22649233,
23368057,
29070403,
27904601,
21304147,
18614443,
19687757,
18963617,
31283113,
32117609,
21969667,
31026739,
20075603,
31177667,
22230913,
17991599,
31742363,
16684883,
28928489,
27727963,
31979551,
18222473,
20765083,
21593983,
19616587,
20079973,
19264631,
31676243,
28946273,
19191467,
28142183,
25948289,
29631737,
22524739,
18972869,
23856557,
17074513,
29322641,
17053259,
22078493,
19048481,
21328663,
30606193,
28202429,
23192317,
21018967,
24053053,
28232273,
24566593,
26175703,
18202543,
21125843,
16914113,
18148513,
19996019,
31703621,
18809389,
23678267,
27010147,
24270803,
18305129,
19251677,
15545879,
31381841,
30981689,
23687611,
27890113,
20799343,
19173017,
19736923,
23348597,
21194479,
21564533,
26686921,
17713021,
19710827,
25242809,
17247161,
27980083,
30595549,
18978097,
16431193,
19583999,
29704607,
17147677,
29604397,
16690909,
23807027,
30143573,
29344691,
15826561,
28759879,
25333163,
27428741,
18256339,
20640679,
30894337,
18555293,
22449461,
18119921,
27129071,
19069847,
23883059,
20165681,
20942863,
27722033,
18540971,
32266973,
17347391,
17454323,
23726309,
17670347]

MAX_HASH_FNS = 1024

R = 26
B = 39

assert R * B <= MAX_HASH_FNS

np.random.seed(42)

FROM = 3
TO = 49999

CONSTANT = 20

a = np.zeros(MAX_HASH_FNS)
b = np.zeros(MAX_HASH_FNS)

for i in range(0, MAX_HASH_FNS):
    a[i] = random.randint(FROM, TO)
    b[i] = random.randint(FROM, TO)

# min hashing
def hash_fns(values):
    hashed = np.ones((2, MAX_HASH_FNS)) * sys.maxint
    for val in values:
        hashed[1, :] = ((a * val + b) % PRIMES) % CONSTANT
        hashed[0, :] = np.min(hashed, axis=0)
    return hashed[0]

# vector (signature of band) of len R -> int
def hash_col(band_index, band_signature):
    # TODO: modulo later
    from_index = band_index * R
    to_index = band_index * R + min(R, band_signature.shape[0])
    return np.sum(((a[from_index:to_index] * band_signature + b[from_index : to_index])
        % PRIMES[from_index : to_index]) % CONSTANT) % CONSTANT

def mapper(key, value):
    # key: None
    # value: one line of input file
    document, values_str = value.split(None, 1)
    document = int(document.split('_')[1])

    values = np.asarray(values_str.split(), dtype=np.uint64)
    # vector of MAX_HASH_FNS hashes
    hashes = hash_fns(values)

    signatures = np.zeros((B), dtype=np.uint64)
    for band_index in range(0, B):
        sig_vec = hashes[band_index * R : (band_index + 1) * R]
        signatures[band_index] = hash_col(band_index, sig_vec)
    str_signatures = [str(i) for i in signatures]
    sig_key = "-".join(str_signatures)
    yield sig_key, document

def reducer(key, values):
    # key: key from mapper used to aggregate
    # values: list of all value for that key
    num_of_docs = len(values)

    for i in range(len(values)):
       for j in range(i + 1, len(values)):
            yield values[i], values[j]


